@page "/login"
@using System.Net.Http
@* @using Microsoft.AspNetCore.Components.Forms*@
@using Microsoft.AspNetCore.Components.Server;
@* @using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage; *@
@using DarianTablet.Shared.Dto;
@using DarianTablet.Shared;


@inherits BaseComponent



<h3>ورود به سیستم</h3>

<div style="width:350px; align-items:center;">

    <div style="direction:rtl; align-content:center;">
        <div class="form-group">
            <label for="userName">نام کاربری</label>
            <input type="text" id="userName" maxlength="25" class="form-control" @bind="loginModel.UserName" style="width:70%;" />
        </div>

        <div class="form-group">
            <label for="password">رمز عبور</label>
            <input id="password" type="password" maxlength="30" class="form-control" @bind="loginModel.Password" style="width:70%;" />
        </div>
        <div style="direction:rtl; align-content:flex-start; text-align:right; padding-top:10px;">
            <button type="submit" class="btn btn-primary" @onclick="HandleValidSubmit">ورود به سیستم</button>
        </div>
    </div>
</div>

<_ErrorModal @ref="errorModal" />

@code {
    private LoginViewModel loginModel = new LoginViewModel();
    private _ErrorModal errorModal;


    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender)
            return;


        StateHasChanged();
    }





    protected override async Task OnInitializedAsync()
    {
        //     await LoadBaseUrlAsync();
    }



    private async Task<string> validation()
    {
        string message = string.Empty;

        if (string.IsNullOrEmpty(loginModel.UserName))
        {
            message += "نام کاربری را وارد کنید" + '\n';
        }
        if (string.IsNullOrEmpty(loginModel.Password))
        {
            message += "رمز عبور را وارد کنید";
        }


        return message;

    }



    private async Task ShowErrorMessage(string title, string message)
    {
        errorModal.Show(message, title);
    }


    private async void HandleValidSubmit()
    {
         string errormessage = await validation();
        if (!string.IsNullOrEmpty(errormessage))
        {
            await ShowErrorMessage("خطا", errormessage);

            return;
        }



        // نمونه‌سازی درخواست و ارسال به سرور
        var response = await ApiClient.PostAsync<AuthResponseDto>("auth/login", loginModel);

        if (response.IsSucces)
        {

            Token=response.access_token;
         
            await ProtectedLocalStorage.SetAsync("Token", Token);

            var result =await ProtectedLocalStorage.GetAsync<string>("Token");
           
            OpenLink("/Product/product-list");
        }
        else
        {
            await ShowErrorMessage("خطا", "نام کاربری یا رمز عبور اشتباه است");
        }
    }


}
