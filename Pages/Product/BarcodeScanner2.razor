@page "/barcode-scanner2"

@using BlazorBarcodeScanner.ZXing.JS
@inject BarcodeScannerService ScannerService
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-barcode me-2"></i>
                        اسکنر بارکد
                    </h4>
                </div>
                <div class="card-body">
                    <!-- کنترل‌های اسکنر -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="btn-group" role="group">
                                <button class="btn btn-success" @onclick="StartScanning">
                                    <i class="fas fa-play me-1"></i> شروع اسکن
                                </button>
                                <button class="btn btn-warning" @onclick="StopScanning">
                                    <i class="fas fa-stop me-1"></i> توقف اسکن
                                </button>
                                <button class="btn btn-info" @onclick="ToggleCamera" disabled>
                                    <i class="fas fa-camera me-1"></i> تغییر دوربین
                                </button>
                            </div>
                        </div>
                        <div class="col-md-6 text-end">
                            <button class="btn btn-secondary me-2" @onclick="ClearResults">
                                <i class="fas fa-eraser me-1"></i> پاک کردن نتایج
                            </button>
                            <button class="btn btn-outline-secondary" @onclick="GoHome">
                                <i class="fas fa-home me-1"></i> بازگشت
                            </button>
                        </div>
                    </div>

                    <!-- وضعیت اسکنر -->
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>وضعیت:</strong> @statusMessage
                    </div>

                    <!-- اسکنر بارکد -->
                    <div class="text-center mb-4">
                        <BarcodeReader @ref="barcodeReader"
                                       VideoWidth="400"
                                       VideoHeight="300"
                                       OnBarcodeReceived="OnBarcodeDetected"
                                       OnErrorReceived="OnErrorOccurred"
                                       OnDecodingChanged="OnDecodingStateChanged" />
                    </div>

                    <!-- نتایج اسکن -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0">
                                        <i class="fas fa-check-circle me-2"></i>
                                        آخرین بارکد اسکن شده
                                    </h5>
                                </div>
                                <div class="card-body">
                                    @if (!string.IsNullOrEmpty(lastScannedBarcode))
                                    {
                                        <div class="text-center">
                                            <h3 class="text-success">@lastScannedBarcode</h3>
                                            <div class="mt-3">
                                                <button class="btn btn-outline-success me-2" @onclick="CopyToClipboard">
                                                    <i class="fas fa-copy me-1"></i> کپی
                                                </button>
                                                <button class="btn btn-outline-primary" @onclick="SearchBarcode">
                                                    <i class="fas fa-search me-1"></i> جستجو
                                                </button>
                                            </div>
                                        </div>
                                    }
                                    else
                                    {
                                        <p class="text-muted text-center">هنوز بارکدی اسکن نشده است</p>
                                    }
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-info text-white">
                                    <h5 class="mb-0">
                                        <i class="fas fa-history me-2"></i>
                                        تاریخچه اسکن
                                    </h5>
                                </div>
                                <div class="card-body" style="max-height: 200px; overflow-y: auto;">
                                    @if (scanHistory.Any())
                                    {
                                        <ul class="list-group list-group-flush">
                                            @foreach (var item in scanHistory.Take(5))
                                            {
                                                <li class="list-group-item">@item</li>
                                            }
                                        </ul>
                                    }
                                    else
                                    {
                                        <p class="text-muted text-center">تاریخچه‌ای موجود نیست</p>
                                    }
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- تنظیمات ساده‌شده -->
                    <div class="card mt-3">
                        <div class="card-header bg-secondary text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-cog me-2"></i>
                                تنظیمات اسکنر
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <label class="form-label">فرمت بارکد:</label>
                                    <select @bind="selectedFormat" class="form-select">
                                        <option value="All">همه فرمت‌ها</option>
                                        <option value="AZTEC">AZTEC</option>
                                        <option value="CODE_128">CODE_128</option>
                                        <option value="CODE_39">CODE_39</option>
                                        <option value="EAN_13">EAN_13</option>
                                        <option value="EAN_8">EAN_8</option>
                                        <option value="QR_CODE">QR_CODE</option>
                                        <option value="UPC_A">UPC_A</option>
                                        <option value="UPC_E">UPC_E</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-check form-switch mt-4">
                                        <input class="form-check-input" type="checkbox" @bind="autoStart" />
                                        <label class="form-check-label">شروع خودکار اسکن</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private BlazorBarcodeScanner.ZXing.JS.BarcodeReader? barcodeReader;
    private string statusMessage = "آماده برای اسکن";
    private string lastScannedBarcode = string.Empty;
    private List<string> scanHistory = new List<string>();
    private string selectedFormat = "All";
    private bool autoStart = false;
    private bool isScanning = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            if (autoStart)
            {
                await StartScanning();
            }

            // ثبت event handler برای سرویس
            ScannerService.OnBarcodeScanned += HandleBarcodeFromService;
        }
    }

    private async Task StartScanning()
    {
        try
        {
            // استفاده از متدهای صحیح کتابخانه
            await barcodeReader!.StartDecoding();
            isScanning = true;
            statusMessage = "در حال اسکن... بارکد را در مقابل دوربین قرار دهید";
            StateHasChanged();
        }
        catch (Exception ex)
        {
            statusMessage = $"خطا در شروع اسکن: {ex.Message}";
            StateHasChanged();
        }
    }

    private async Task StopScanning()
    {
        try
        {
            await barcodeReader!.StopDecoding();
            isScanning = false;
            statusMessage = "اسکن متوقف شد";
            StateHasChanged();
        }
        catch (Exception ex)
        {
            statusMessage = $"خطا در توقف اسکن: {ex.Message}";
            StateHasChanged();
        }
    }

    private async Task ToggleCamera()
    {
        // غیرفعال شده - نیاز به پیاده‌سازی با JS Interop دارد
        statusMessage = "قابلیت تغییر دوربین در حال حاضر غیرفعال است";
        StateHasChanged();
    }

    private void OnBarcodeDetected(BarcodeReceivedEventArgs args)
    {
        if (!string.IsNullOrEmpty(args.BarcodeText))
        {
            lastScannedBarcode = args.BarcodeText;
            scanHistory.Insert(0, $"{DateTime.Now:HH:mm:ss} - {args.BarcodeText}");

            // اطلاع به سرویس
            _ = ScannerService.NotifyBarcodeScanned(args.BarcodeText);

            statusMessage = $"بارکد شناسایی شد: {args.BarcodeText}";
            StateHasChanged();

            // پخش صدای موفقیت
            _ = PlayBeepSound();
        }
    }

    private void OnErrorOccurred(ErrorReceivedEventArgs args)
    {
        statusMessage = $"خطا: {args.Message}";
        StateHasChanged();
    }

    private void OnDecodingStateChanged(DecodingChangedArgs args)
    {
        statusMessage = args.IsDecoding ? "در حال اسکن..." : "آماده برای اسکن";
        StateHasChanged();
    }

    private async Task HandleBarcodeFromService(string barcode)
    {
        // این متد وقتی فراخوانی می‌شود که بارکد از طریق سرویس اطلاع‌رسانی شود
        await InvokeAsync(StateHasChanged);
    }

    private async Task CopyToClipboard()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", lastScannedBarcode);
            statusMessage = "بارکد در کلیپ‌بورد کپی شد";
            StateHasChanged();
        }
        catch (Exception ex)
        {
            statusMessage = $"خطا در کپی کردن: {ex.Message}";
            StateHasChanged();
        }
    }

    private async Task SearchBarcode()
    {
        // اینجا می‌توانید منطق جستجوی بارکد را اضافه کنید
        await JSRuntime.InvokeVoidAsync("alert", $"جستجو برای بارکد: {lastScannedBarcode}");
    }

    private void ClearResults()
    {
        lastScannedBarcode = string.Empty;
        scanHistory.Clear();
        ScannerService.ClearHistory();
        statusMessage = "نتایج پاک شد";
        StateHasChanged();
    }

    private void GoHome()
    {
        Navigation.NavigateTo("/");
    }
    private async Task PlayBeepSound()
    {
        try
        {
            // تقسیم رشته base64 به چند بخش کوچکتر
            string audioBase64 =
                "//uQRAAAAWMSLwUIYAAsYkXgoQwAEaYLWfkWgAI0wWs/ItAAAGDgYtAgAyN+" +
                "QWaAAihwMWm4G8QQRDiMcCBcH3Cc+CDv/7xA4Tvh9Rz/y8QADBwMWgQAZG/ILNAARQ4GLTcDeIIIhxGOBAuD7hOfBB3/94gcJ3w+o5/5eIAIAAAVwWgQAVQ2ORaIQwEMAJiDg95G4nQL7mQVWI6GwRcfsZAcsKkJvxgxEjzFUgfHoSQ9Qq7KNwqHwuB13MA4a1q/DmBrHgPcmjiGoh//EwC5nGPEmS4RcfkVKOhJf+WOgoxJclFz3kgn//dBA+ya1GhurNn8zb//9NNutNuhz31f////9vt///z+IdAEAAAK4LQIAKobHItEIYCGAExBwe8jcToF9zIKrEdDYIuP2MgOWFSE34wYiR5iqQPj0JIeoVdlG4VD4XA67mAcNa1fhzA1jwHuTRxDUQ//iYBczjHiTJcIuPyKlHQkv/LHQUYkuSi57yQT//uggfZNajQ3Vmz+Zt//+mm3Wm3Q576v////+32///5/EOgAAADVghQAAAAA//uQZAUAB1WI0PZugAAAAAoQwAAAEk3nRd2qAAAAACiDgAAAAAAABCqEEQRLCgwpBGMlJkIz8jKhGvj4k6jzRnqasNKIeoh5gI7BJaC1A1AoNBjJgbyApVS4IDlZgDU5WUAxEKDNmmALHzZp0Fkz1FMTmGFl1FMEyodIavcCAUHDWrKAIA4aa2oCgILEBupZgHvAhEBcZ6joQBxS76AgccrFlczBvKLC0QI2cBoCFvfTDAo7eoOQInqDPBtvrDEZBNYN5xwNwxQRfw8ZQ5wQVLvO8OYU+mHvFLlDh05Mdg7BT6YrRPpCBznMB2r//xKJjyyOh+cImr2/4doscwD6neZjuZR4AgAABYAAAABy1xcdQtxYBYYZdifkUDgzzXaXn98Z0oi9ILU5mBjFANmRwlVJ3/6jYDAmxaiDG3/6xjQQCCKkRb/6kg/wW+kSJ5//rLobkLSiKmqP/0ikJuDaSaSf/6JiLYLEYnW/+kXg1WRVJL/9EmQ1YZIsv/6Qzwy5qk7/+tEU0nkls3/zIUMPKNX/6yZLf+kFgAfgGyLFAUwY" +
                "//uQZAUABcd5UiNPVXAAAApAAAAAE0VZQKw9ISAAACgAAAAAVQIygIElVrFkBS+Jhi+EAuu+lKAkYUEIsmEAEoMeDmCETMvfSHTGkF5RWH7kz/ESHWPAq/kcCRhqBtMdokPdM7vil7RG98A2sc7zO6ZvTdM7pmOUAZTnJW+NXxqmd41dqJ6mLTXxrPpnV8avaIf5SvL7pndPvPpndJR9Kuu8fePvuiuhorgWjp7Mf/PRjxcFCPDkW31srioCExivv9lcwKEaHsf/7ow2Fl1T/9RkXgEhYElAoCLFtMArxwivDJJ+bR1HTKJdlEoTELCIqgEwVGSQ+hIm0NbK8WXcTEI0UPoa2NbG4y2K00JEWbZavJXkYaqo9CRHS55FcZTjKEk3NKoCYUnSQ0rWxrZbFKbKIhOKPZe1cJKzZSaQrIyULHDZmV5K4xySsDRKWOruanGtjLJXFEmwaIbDLX0hIPBUQPVFVkQkDoUNfSoDgQGKPekoxeGzA4DUvnn4bxzcZrtJyipKfPNy5w+9lnXwgqsiyHNeSVpemw4bWb9psYeq" +
                "//uQZBoABQt4yMVxYAIAAAkQoAAAHvYpL5m6AAgAACXDAAAAD59jblTirQe9upFsmZbpMudy7Lz1X1DYsxOOSWpfPqNX2WqktK0DMvuGwlbNj44TleLPQ+Gsfb+GOWOKJoIrWb3cIMeeON6lz2umTqMXV8Mj30yWPpjoSa9ujK8SyeJP5y5mOW1D6hvLepeveEAEDo0mgCRClOEgANv3B9a6fikgUSu/DmAMATrGx7nng5p5iimPNZsfQLYB2sDLIkzRKZOHGAaUyDcpFBSLG9MCQALgAIgQs2YunOszLSAyQYPVC2YdGGeHD2dTdJk1pAHGAWDjnkcLKFymS3RQZTInzySoBwMG0QueC3gMsCEYxUqlrcxK6k1LQQcsmyYeQPdC2YfuGPASCBkcVMQQqpVJshui1tkXQJQV0OXGAZMXSOEEBRirXbVRQW7ugq7IM7rPWSZyDlM3IuNEkxzCOJ0ny2ThNkyRai1b6ev//3dzNGzNb//4uAvHT5sURcZCFcuKLhOFs8mLAAEAt4UWAAIABAAAAAB4qbHo0tIjVkUU" +
                "//uQZAwABfSFz3ZqQAAAAAngwAAAE1HjMp2qAAAAACZDgAAAD5UkTE1UgZEUExqYynN1qZvqIOREEFmBcJQkwdxiFtw0qEOkGYfRDifBui9MQg4QAHAqWtAWHoCxu1Yf4VfWLPIM2mHDFsbQEVGwyqQoQcwnfHeIkNt9YnkiaS1oizycqJrx4KOQjahZxWbcZgztj2c49nKmkId44S71j0c8eV9yDK6uPRzx5X18eDvjvQ6yKo9ZSS6l//8elePK/Lf//IInrOF/FvDoADYAGBMGb7FtErm5MXMlmPAJQVgWta7Zx2go+8xJ0UiCb8LHHdftWyLJE0QIAIsI+UbXu67dZMjmgDGCGl1H+vpF4NSDckSIkk7Vd+sxEhBQMRU8j/12UIRhzSaUdQ+rQU5kGeFxm+hb1oh6pWWmv3uvmReDl0UnvtapVaIzo1jZbf/pD6ElLqSX+rUmOQNpJFa/r+sa4e/pBlAABoAAAAA3CUgShLdGIxsY7AUABPRrgCABdDuQ5GC7DqPQCgbbJUAoRSUj+NIEig0YfyWUho1VBBBA" +
                "//uQZB4ABZx5zfMakeAAAAmwAAAAF5F3P0w9GtAAACfAAAAAwLhMDmAYWMgVEG1U0FIGCBgXBXAtfMH10000EEEEEECUBYln03TTTdNBDZopopYvrTTdNa325mImNg3TTPV9q3pmY0xoO6bv3r00y+IDGid/9aaaZTGMuj9mpu9Mpio1dXrr5HERTZSmqU36A3CumzN/9Robv/Xx4v9ijkSRSNLQhAWumap82WRSBUqXStV/YcS+XVLnSS+WLDroqArFkMEsAS+eWmrUzrO0oEmE40RlMZ5+ODIkAyKAGUwZ3mVKmcamcJnMW26MRPgUw6j+LkhyHGVGYjSUUKNpuJUQoOIAyDvEyG8S5yfK6dhZc0Tx1KI/gviKL6qvvFs1+bWtaz58uUNnryq6kt5RzOCkPWlVqVX2a/EEBUdU1KrXLf40GoiiFXK///qpoiDXrOgqDR38JB0bw7SoL+ZB9o1RCkQjQ2CBYZKd/+VJxZRRZlqSkKiws0WFxUyCwsKiMy7hUVFhIaCrNQsKkTIsLivwKKigsj8XYlwt/WKi2N4d" +
                "//uQRCSAAjURNIHpMZBGYiaQPSYyAAABLAAAAAAAACWAAAAApUF/Mg+0aohSIRobBAsMlO//Kk4soosy1JSFRYWaLC4qZBYWFRGZdwqKiwkNBVmoWFSJkWFxX4FFRQWR+LsS4W/rFRb/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////VEFHAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAU291bmRib3kuZGUAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAMjAwNGh0dHA6Ly93d3cuc291bmRib3kuZGUAAAAAAAAAACU";

            string jsCode = $"new Audio('data:audio/wav;base64,{audioBase64}').play();";
            await JSRuntime.InvokeVoidAsync("eval", jsCode);
        }
        catch (Exception)
        {
            // در صورت خطا در پخش صدا، کاری نکن
        }
    }
  

   

    public void Dispose()
    {
        ScannerService.OnBarcodeScanned -= HandleBarcodeFromService;
    }
}